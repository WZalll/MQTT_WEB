<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MQTT控制面板</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- Chart.js CDN - 使用稳定版本，带备用 CDN 回退 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js" onerror="(function(){var s=document.createElement('script');s.src='https://unpkg.com/chart.js@3.9.1/dist/chart.min.js';document.head.appendChild(s);}())"></script>
    <!-- MQTT.js CDN -->
    <script src="https://unpkg.com/mqtt@5.1.3/dist/mqtt.min.js"></script>
</head>
<body>
    <!-- 侧边栏导航 -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>MQTT监控</h2>
            <button class="sidebar-toggle" id="sidebarToggle">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
        <nav class="sidebar-nav">
            <ul>
                <li><a href="#dashboard" class="nav-link active" data-page="dashboard">
                    <span class="nav-icon">📊</span>
                    <span class="nav-text">用户</span>
                </a></li>
                <li><a href="#logs" class="nav-link" data-page="logs">
                    <span class="nav-icon">📋</span>
                    <span class="nav-text">日志</span>
                </a></li>
                <li><a href="#settings" class="nav-link" data-page="settings">
                    <span class="nav-icon">⚙️</span>
                    <span class="nav-text">设置</span>
                </a></li>
            </ul>
        </nav>
        <div class="connection-status" id="connectionStatus">
            <span class="status-indicator" id="statusIndicator"></span>
            <span id="statusText">未连接</span>
        </div>
    </div>

    <!-- 主内容区域 -->
    <div class="main-content" id="mainContent">
        <!-- 用户页面 (实时数据和图表) -->
        <div class="page" id="dashboard-page">
            <div class="page-header">
                <h1>实时数据监控</h1>
                <div class="quick-actions">
                    <button id="quickConnectBtn" class="btn btn-primary" disabled>快速连接</button>
                    <button id="startHeartbeatBtn" class="btn btn-success" disabled>启动心跳</button>
                    <button id="stopHeartbeatBtn" class="btn btn-warning" disabled>停止心跳</button>
                </div>
            </div>
            
            <!-- 数据卡片 -->
            <div class="device-status-section">
                <div class="device-status-card">
                    <div class="device-status-header">
                        <h3>设备状态</h3>
                        <div class="device-indicator" id="deviceIndicator">
                            <span class="device-status-dot" id="deviceStatusDot"></span>
                            <span class="device-status-text" id="deviceStatusText">离线</span>
                        </div>
                    </div>
                    <div class="device-info">
                        <div class="device-info-item">
                            <span class="info-label">最后心跳:</span>
                            <span class="info-value" id="lastHeartbeat">--</span>
                        </div>
                        <div class="device-info-item">
                            <span class="info-label">心跳计数:</span>
                            <span class="info-value" id="heartbeatCount">--</span>
                        </div>
                        <div class="device-info-item">
                            <span class="info-label">在线时长:</span>
                            <span class="info-value" id="onlineTime">--</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="data-cards">
                <div class="data-card">
                    <h3>温度</h3>
                    <div class="data-value" id="temperatureValue">--</div>
                    <div class="data-unit">°C</div>
                </div>
                <div class="data-card">
                    <h3>湿度</h3>
                    <div class="data-value" id="humidityValue">--</div>
                    <div class="data-unit">%</div>
                </div>
                <div class="data-card">
                    <h3>转速</h3>
                    <div class="data-value" id="speedValue">--</div>
                    <div class="data-unit">RPM</div>
                </div>
                <div class="data-card">
                    <h3>压力</h3>
                    <div class="data-value" id="pressureValue">--</div>
                    <div class="data-unit">Pa</div>
                </div>
            </div>

            <!-- 实时图表 -->
            <div class="chart-panel">
                <h2>实时数据图表</h2>
                <div class="chart-container">
                    <canvas id="dataChart"></canvas>
                </div>
            </div>
        </div>

        <!-- 日志页面 (日志和设备控制) -->
        <div class="page hidden" id="logs-page">
            <div class="page-header">
                <h1>日志与控制</h1>
            </div>
            
            <!-- 设备控制面板 -->
            <div class="control-panel">
                <h2>设备控制</h2>
                <div class="control-grid">
                    <div class="control-item">
                        <label for="controlMessage">控制消息:</label>
                        <input type="text" id="controlMessage" placeholder='{"command": "start", "speed": 100}'>
                        <button id="sendControlBtn" class="btn btn-primary" disabled>发送</button>
                    </div>
                </div>
                <div class="control-presets">
                    <h3>快捷控制</h3>
                    <button class="btn btn-success preset-btn" data-command='{"command": "start"}'>启动</button>
                    <button class="btn btn-warning preset-btn" data-command='{"command": "stop"}'>停止</button>
                    <button class="btn btn-info preset-btn" data-command='{"command": "reset"}'>重置</button>
                    <button class="btn btn-secondary preset-btn" data-command='{"command": "status"}'>状态查询</button>
                </div>
            </div>

            <!-- 消息日志 -->
            <div class="log-panel">
                <h2>消息日志</h2>
                <div class="log-controls">
                    <button id="clearLogBtn" class="btn btn-secondary">清空日志</button>
                    <label>
                        <input type="checkbox" id="autoScroll" checked> 自动滚动
                    </label>
                </div>
                <div class="log-container" id="logContainer">
                    <!-- 日志消息将在这里显示 -->
                </div>
            </div>
        </div>

        <!-- 设置页面 (MQTT配置) -->
        <div class="page hidden" id="settings-page">
            <div class="page-header">
                <h1>MQTT配置</h1>
            </div>
            
            <div class="config-panel">
                <h2>连接设置</h2>
                <div class="config-grid">
                    <div class="config-item">
                        <label for="brokerUrl">服务器地址:</label>
                        <input type="text" id="brokerUrl" placeholder="wss://broker.emqx.io:8084/mqtt" value="wss://broker.emqx.io:8084/mqtt">
                    </div>
                    <div class="config-item">
                        <label for="clientId">客户端ID:</label>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <input type="text" id="clientId" placeholder="mqtt_web_client_">
                            <button id="randomClientIdBtn" class="btn btn-secondary" type="button">随机</button>
                        </div>
                    </div>
                    <div class="config-item">
                        <label for="username">用户名:</label>
                        <input type="text" id="username" placeholder="可选">
                    </div>
                    <div class="config-item">
                        <label for="password">密码:</label>
                        <input type="password" id="password" placeholder="可选">
                    </div>
                </div>
                
                <h2>主题设置</h2>
                <div class="config-grid">
                    <div class="config-item">
                        <label for="subscribeTopic">订阅主题:</label>
                        <input type="text" id="subscribeTopic" placeholder="esp32/test/mah1ro" value="esp32/test/mah1ro">
                    </div>
                    <div class="config-item">
                        <label for="publishTopic">发布主题:</label>
                        <input type="text" id="publishTopic" placeholder="esp32/test/mah1ro" value="esp32/test/mah1ro">
                    </div>
                    <div class="config-item">
                        <label for="heartbeatTopic">心跳主题:</label>
                        <input type="text" id="heartbeatTopic" placeholder="esp32/test/mah1ro" value="esp32/test/mah1ro">
                    </div>
                    <div class="config-item">
                        <label for="heartbeatInterval">心跳间隔(秒):</label>
                        <input type="number" id="heartbeatInterval" value="30" min="5" max="300">
                    </div>
                </div>
                
                <div class="button-group">
                    <button id="connectBtn" class="btn btn-primary">连接</button>
                    <button id="disconnectBtn" class="btn btn-secondary" disabled>断开</button>
                    <button id="saveConfigBtn" class="btn btn-info">保存配置</button>
                    <button id="resetDefaultsBtn" class="btn btn-secondary">重置为默认</button>
                    <button id="loadConfigBtn" class="btn btn-info">加载配置</button>
                </div>
            </div>
        </div>
    </div>

    <script src="js/mqtt-client.js"></script>
    <script src="js/chart-manager.js"></script>
    <script src="js/app.js"></script>
    <!-- 可选的渲染保障：周期性与可见性变更触发图表刷新（不改动现有逻辑） -->
    <script src="js/chart-fix.js"></script>
</body>
</html>
